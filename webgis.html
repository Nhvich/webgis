<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WebGISåœ°å›¾æµè§ˆå™¨</title>
    <!-- å…ˆå¼•å…¥ Turf.js -->
    <script src="https://unpkg.com/@turf/turf@6/turf.min.js"></script>
    <!-- æ­£ç¡®å¼•å…¥ OpenLayers CSS -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/openlayers/openlayers.github.io@master/en/v6.15.1/css/ol.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/geotiff"></script>
    <script src="https://cdn.jsdelivr.net/npm/ol-shapefile@4.0.0/dist/ol-shapefile.js"></script>
    <script src="https://unpkg.com/shp-write@0.3.2/shp-write.js"></script>
    <script src="https://unpkg.com/shp-write@0.3.2/lib/dbf-writer.js"></script>
    <!-- ç§»é™¤å…¶ä»– shp ç›¸å…³çš„åº“ï¼Œåªä¿ç•™è¿™ä¸€ä¸ª -->
    <script src="https://unpkg.com/shpjs@latest/dist/shp.js"></script>
    <!-- åœ¨ head æ ‡ç­¾ä¸­æ·»åŠ  -->
    <script src="https://unpkg.com/shapefile@0.6.6/dist/shapefile.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body, html {
            width: 100%;
            height: 100%;
            overflow: hidden;
        }

        #container {
            width: 100%;
            height: 100%;
            position: relative;
        }

        #map {
            width: 100%;
            height: 100%;
            position: absolute;
            left: 300px;
            right: 0;
        }

        #sidebar {
            position: absolute;
            left: 0;
            top: 0;
            width: 300px;
            height: 100%;
            background: rgba(255, 255, 255, 0.95);
            box-shadow: 2px 0 10px rgba(0,0,0,0.1);
            z-index: 1000;
            border-right: 1px solid #eee;
            overflow-y: auto;
            overflow-x: hidden;
        }

        #sidebar::-webkit-scrollbar {
            width: 8px;
        }

        #sidebar::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 4px;
        }

        #sidebar::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 4px;
        }

        #sidebar::-webkit-scrollbar-thumb:hover {
            background: #555;
        }

        #sidebar > * {
            padding: 20px;
        }

        #sidebar > *:last-child {
            margin-bottom: 20px;
        }

        #sidebar h2 {
            color: #333;
            margin-bottom: 20px;
            font-size: 18px;
            border-bottom: 2px solid #4CAF50;
            padding-bottom: 10px;
        }

        #toolbar {
            position: absolute;
            top: 20px;
            right: 20px;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 6px;
            padding: 6px;
            z-index: 1000;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            border: 1px solid #eee;
        }

        .tool-button {
            padding: 6px;
            margin: 2px;
            background: #fff;
            border: 1px solid #ddd;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s ease;
            width: 30px;
            height: 30px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
        }

        .tool-button:hover {
            background: #f8f8f8;
            transform: translateY(-1px);
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }

        .tool-button.active {
            background: #4CAF50;
            color: white;
            border-color: #45a049;
            box-shadow: 0 2px 5px rgba(76,175,80,0.3);
        }

        .tool-button img {
            width: 16px;
            height: 16px;
        }

        .tool-button.active img {
            filter: brightness(0) invert(1);
        }

        #status-bar {
            position: absolute;
            bottom: 20px;
            right: 20px;
            width: 240px;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 6px;
            padding: 8px;
            z-index: 1000;
            font-size: 12px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            border: 1px solid #eee;
        }

        #coordinates, #scale {
            display: block;
            margin: 3px 0;
            white-space: nowrap;
            color: #333;
            font-family: 'Consolas', monospace;
            padding: 4px 6px;
            background: #f8f8f8;
            border-radius: 3px;
            font-size: 11px;
        }

        .layer-item {
            margin: 0;
        }
        
        /* æ·»åŠ æˆ–ä¿®æ”¹å›¾å±‚æŒ‰é’®æ ·å¼ */
        .layer-button {
            display: flex;
            align-items: center;
            width: 100%;
            height: 60px;  /* è°ƒæ•´é«˜åº¦ */
            padding: 0;
            background: white;
            border: 2px solid #4dd2ff;  /* æ·»åŠ è“è‰²è¾¹æ¡† */
            border-radius: 15px;        /* å¢åŠ åœ†è§’ */
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
            margin-bottom: 15px;      /* å¢åŠ æŒ‰é’®é—´è· */
        }
        
        .layer-icon {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-size: cover;
            background-position: center;
            z-index: 1;
        }
        
        /* æ–‡å­—æ ·å¼ */
        .layer-button span {
            position: relative;
            z-index: 2;
            width: 100%;
            text-align: center;
            font-size: 16px;
            font-weight: bold;
            color: white;
            text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.5);  /* æ·»åŠ æ–‡å­—é˜´å½± */
        }

        .layer-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 10px rgba(77, 210, 255, 0.3);  /* è“è‰²é˜´å½± */
        }

        .layer-button.active {
            border-color: #4CAF50;
            box-shadow: 0 0 0 2px rgba(76, 175, 80, 0.3);
        }

        /* é«˜å¾·åœ°å›¾å›¾æ ‡ */
        .gaode-layer .layer-icon {
            background-color: #f0f0f0; /* æ·»åŠ ä¸´æ—¶èƒŒæ™¯è‰² */
            background-image: linear-gradient(rgba(255, 255, 255, 0.1), rgba(255, 255, 255, 0.1)), url('icon/gaode.jpg');
        }

        /* ArcGISå«æ˜Ÿå½±åƒå›¾æ ‡ */
        .arcgis-layer .layer-icon {
            background-image: linear-gradient(rgba(0, 0, 0, 0.1), rgba(0, 0, 0, 0.1)), url('icon/Arcgis.jpg');
        }

        /* æ¿€æ´»çŠ¶æ€ä¸‹çš„å›¾æ ‡è¾¹æ¡† */
        .layer-button.active .layer-icon {
            border-color: white;
        }

        .tooltip {
            position: relative;
            background: rgba(0, 0, 0, 0.8);
            border-radius: 6px;
            color: white;
            padding: 6px 12px;
            white-space: nowrap;
            font-size: 13px;
            pointer-events: none;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }

        .tooltip-measure {
            opacity: 1;
            font-weight: bold;
        }

        .tooltip-static {
            background-color: #ffcc33;
            color: black;
            border: 1px solid white;
        }

        .marker-tooltip {
            background: white;
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 15px;
            font-size: 14px;
            box-shadow: 0 2px 12px rgba(0,0,0,0.15);
            min-width: 200px;
        }

        .marker-tooltip input[type="text"] {
            width: 100%;
            padding: 8px 12px;
            margin-bottom: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
            outline: none;
            transition: border-color 0.3s ease;
        }

        .marker-tooltip input[type="text"]:focus {
            border-color: #4CAF50;
            box-shadow: 0 0 0 2px rgba(76,175,80,0.2);
        }

        .marker-tooltip button {
            width: 100%;
            padding: 8px 16px;
            background: #4CAF50;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s ease;
        }

        .marker-tooltip button:hover {
            background: #45a049;
            transform: translateY(-1px);
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }

        /* æ ‡æ³¨æ–‡æœ¬æ ·å¼ */
        .marker-label {
            background: white;
            padding: 4px 8px;
            border-radius: 4px;
            border: 1px solid #ddd;
            font-size: 12px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            pointer-events: none;
            white-space: nowrap;
        }

        .file-upload-section {
            margin-top: 30px;
            padding-top: 20px;
            border-top: 1px solid #eee;
        }

        .file-upload-section h3 {
            color: #333;
            font-size: 16px;
            margin-bottom: 15px;
        }

        .upload-button {
            width: 100%;
            padding: 10px;
            background: #4CAF50;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s ease;
        }

        .upload-button:hover {
            background: #45a049;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }

        .file-list {
            margin-top: 10px;
        }

        .file-item {
            padding: 8px;
            margin: 5px 0;
            background: #f8f8f8;
            border-radius: 4px;
            font-size: 12px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .file-item:hover {
            background: #f0f0f0;
            transform: translateX(3px);
        }

        .file-item span {
            flex: 1;
            padding: 0 8px;
        }

        .file-item button {
            padding: 3px 8px;
            background: #ff4444;
            color: white;
            border: none;
            border-radius: 3px;
            cursor: pointer;
            font-size: 11px;
            z-index: 1;
        }

        .tools-section {
            margin: 20px 0;
            padding: 15px;
            background: #f8f8f8;
            border-radius: 8px;
        }

        .tools-section h3 {
            color: #333;
            font-size: 16px;
            margin-bottom: 15px;
            padding-bottom: 8px;
            border-bottom: 2px solid #4CAF50;
        }

        .tools-group {
            margin: 15px 0;
            padding: 15px;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 6px rgba(0,0,0,0.08);
        }

        .tools-group h4 {
            color: #333;
            font-size: 14px;
            margin-bottom: 15px;
            padding-bottom: 8px;
            border-bottom: 2px solid #4CAF50;
            display: flex;
            align-items: center;
        }

        .tools-group h4::before {
            content: '';
            display: inline-block;
            width: 16px;
            height: 16px;
            margin-right: 8px;
            background-size: contain;
            background-repeat: no-repeat;
        }

        .tools-group.drawing h4::before {
            background-image: url('icon/draw.png');
        }

        .tools-group.editing h4::before {
            background-image: url('icon/edit.png');
        }

        .tool-buttons {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 8px;
            margin-bottom: 10px;
        }

        .tool-buttons button {
            padding: 8px;
            background: white;
            border: 1px solid #ddd;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            transition: all 0.3s ease;
        }

        .tool-buttons button:hover {
            background: #f0f0f0;
            transform: translateY(-2px);
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }

        .tool-buttons button.active {
            background: #4CAF50;
            color: white;
            border-color: #45a049;
        }

        .tools-section,
        .file-upload-section,
        .layer-item {
            width: 100%;
            max-width: 280px;
        }

        .style-settings {
            margin-top: 15px;
            padding: 15px;
            background: #f8f8f8;
            border-radius: 6px;
        }

        .style-settings h5 {
            color: #333;
            font-size: 13px;
            margin-bottom: 12px;
            font-weight: 600;
        }

        .style-options {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .style-row {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .style-row label {
            font-size: 12px;
            color: #555;
            width: 80px;
        }

        /* ä¿®æ”¹ CSS æ ·å¼ï¼Œæ·»åŠ æ ‡å‡†å±æ€§å’Œæµè§ˆå™¨å‰ç¼€ */
        input[type="color"] {
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
            width: 40px;
            height: 30px;
            padding: 0;
            border: 1px solid #ddd;
            border-radius: 4px;
            cursor: pointer;
        }

        input[type="range"] {
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
            width: 100%;
            height: 6px;
            background: #ddd;
            border-radius: 3px;
            outline: none;
        }

        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 16px;
            height: 16px;
            background: #4CAF50;
            border-radius: 50%;
            cursor: pointer;
        }

        input[type="range"]::-moz-range-thumb {
            width: 16px;
            height: 16px;
            background: #4CAF50;
            border-radius: 50%;
            cursor: pointer;
            border: none;
        }

        .style-row input[type="range"]::-webkit-slider-thumb:hover {
            transform: scale(1.1);
        }

        .draw-buttons-container {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 8px;
            margin-bottom: 15px;
        }

        .draw-button {
            width: 50px;
            height: 60px;
            padding: 8px 4px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 4px;
            background: white;
            border: 1px solid #e0e0e0;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .draw-button:hover {
            background: #f5f5f5;
            transform: translateY(-2px);
            box-shadow: 0 3px 6px rgba(0,0,0,0.1);
        }

        .draw-button.active {
            background: #4CAF50;
            border-color: #43A047;
            box-shadow: 0 2px 4px rgba(76,175,80,0.3);
        }

        .draw-button img {
            width: 22px;
            height: 22px;
            object-fit: contain;
            transition: all 0.2s ease;
        }

        .draw-button span {
            font-size: 11px;
            color: #666;
            text-align: center;
            line-height: 1.2;
        }

        .draw-button.active span {
            color: white;
        }

        .features-list {
            margin-top: 15px;
            padding: 12px;
            background: #f8f8f8;
            border-radius: 6px;
        }

        .features-list h5 {
            color: #333;
            font-size: 13px;
            margin-bottom: 10px;
            font-weight: 600;
        }

        .features-container {
            max-height: 200px;
            overflow-y: auto;
        }

        .feature-item {
            display: flex;
            align-items: center;
            padding: 8px;
            margin: 4px 0;
            background: white;
            border: 1px solid #eee;
            border-radius: 4px;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .feature-item:hover {
            background: #f5f5f5;
            transform: translateX(3px);
        }

        .feature-item.selected {
            background: #e3f2fd;
            border-color: #2196F3;
            box-shadow: 0 2px 4px rgba(33, 150, 243, 0.2);
        }

        .feature-icon {
            width: 20px;
            height: 20px;
            margin-right: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .feature-icon img {
            width: 16px;
            height: 16px;
            object-fit: contain;
        }

        .feature-name {
            flex: 1;
        }

        .feature-actions {
            display: flex;
            gap: 4px;
        }

        .feature-actions button {
            padding: 4px;
            background: none;
            border: none;
            cursor: pointer;
            opacity: 0.6;
            transition: opacity 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .feature-actions button:hover {
            opacity: 1;
            background: rgba(0, 0, 0, 0.05);
            border-radius: 3px;
        }

        .download-btn img {
            filter: invert(50%) sepia(50%) saturate(1000%) hue-rotate(190deg);
        }

        .download-btn:hover img {
            filter: invert(50%) sepia(80%) saturate(1500%) hue-rotate(190deg);
        }

        .analysis-dialog {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
            z-index: 2000;
            min-width: 300px;
        }

        .analysis-dialog h3 {
            color: #333;
            margin-bottom: 15px;
            padding-bottom: 8px;
            border-bottom: 2px solid #4CAF50;
        }

        .dialog-content {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .input-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .input-group label {
            font-size: 13px;
            color: #666;
        }

        .input-group input[type="number"] {
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            width: 100%;
            font-size: 14px;
        }

        .style-row {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-top: 5px;
        }

        .style-row label {
            width: 70px;
        }

        .style-row input[type="color"] {
            width: 40px;
            height: 30px;
            padding: 2px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }

        .style-row input[type="range"] {
            flex: 1;
        }

        .dialog-buttons {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
            margin-top: 20px;
        }

        .dialog-buttons button {
            padding: 8px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.2s ease;
        }

        .dialog-buttons .primary-button {
            background: #4CAF50;
            color: white;
        }

        .dialog-buttons .secondary-button {
            background: #f5f5f5;
            color: #666;
        }

        .dialog-buttons button:hover {
            transform: translateY(-2px);
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }

        /* åˆ†æå·¥å…·æŒ‰é’®æ ·å¼ */
        .analysis-button {
            width: 100%;
            padding: 8px;
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 8px;
            background: white;
            border: 1px solid #ddd;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .analysis-button img {
            width: 20px;
            height: 20px;
        }

        .analysis-button span {
            flex: 1;
            text-align: left;
            font-size: 14px;
            color: #333;
        }

        .analysis-button:hover {
            background: #f5f5f5;
            transform: translateX(3px);
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }

        .analysis-button.active {
            background: #4CAF50;
            border-color: #45a049;
        }

        .analysis-button.active span {
            color: white;
        }

        .analysis-button.active img {
            filter: brightness(0) invert(1);
        }

        /* å¯¹è¯æ¡†æ ·å¼ */
        .dialog-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .analysis-dialog {
            background: white;
            border-radius: 8px;
            padding: 20px;
            min-width: 300px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
        }

        .dialog-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .dialog-header h3 {
            margin: 0;
            color: #333;
        }

        .close-btn {
            font-size: 24px;
            cursor: pointer;
            color: #666;
        }

        .dialog-content {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .input-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .input-group label {
            color: #666;
        }

        .input-group input[type="number"] {
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }

        .style-row {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .dialog-buttons {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
            margin-top: 20px;
        }

        .primary-button, .secondary-button {
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
            border: none;
            transition: all 0.3s ease;
        }

        .primary-button {
            background: #4CAF50;
            color: white;
        }

        .secondary-button {
            background: #f5f5f5;
            color: #666;
        }

        .primary-button:hover {
            background: #45a049;
        }

        .secondary-button:hover {
            background: #e0e0e0;
        }

        /* åŠ è½½æç¤ºæ ·å¼ */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            color: white;
            z-index: 1000;
        }

        .loading-spinner {
            width: 40px;
            height: 40px;
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3498db;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 10px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* æ–‡ä»¶æ“ä½œæŒ‰é’®æ ·å¼ */
        .file-buttons {
            display: flex;
            flex-direction: column;
            gap: 8px;
            padding: 10px;
        }

        .file-button {
            display: flex;
            align-items: center;
            gap: 8px;
            width: 100%;
            padding: 8px;
            background: white;
            border: 1px solid #ddd;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .file-button img {
            width: 20px;
            height: 20px;
        }

        .file-button span {
            flex: 1;
            text-align: left;
            font-size: 14px;
            color: #333;
        }

        .file-button:hover {
            background: #f5f5f5;
            transform: translateX(3px);
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }

        /* åŠ è½½æ–‡ä»¶åˆ—è¡¨æ ·å¼ */
        .loaded-files {
            margin-top: 10px;
            border-top: 1px solid #eee;
            padding-top: 10px;
        }

        .file-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 5px 8px;
            margin-bottom: 5px;
            background: #f9f9f9;
            border: 1px solid #eee;
            border-radius: 4px;
        }

        .file-item .file-name {
            flex: 1;
            font-size: 13px;
            color: #333;
            margin-right: 10px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .file-item .file-controls {
            display: flex;
            gap: 5px;
        }

        .file-item .file-controls button {
            padding: 2px 6px;
            border: 1px solid #ddd;
            border-radius: 3px;
            background: white;
            cursor: pointer;
            font-size: 12px;
        }

        .file-item .file-controls button:hover {
            background: #f5f5f5;
        }

        .file-item .file-type-icon {
            width: 16px;
            height: 16px;
            margin-right: 8px;
        }
    </style>
</head>
<body>
    <div id="container">
        <div id="sidebar">
            <h2>å›¾å±‚ç®¡ç†</h2>
            <div id="layers-list">
                <div class="layer-item">
                    <button class="layer-button gaode-layer" data-layer="gaode">
                        <div class="layer-icon"></div>
                        <span>é«˜å¾·åœ°å›¾</span>
                    </button>
                </div>
                <div class="layer-item">
                    <button class="layer-button arcgis-layer" data-layer="arcgis">
                        <div class="layer-icon"></div>
                        <span>ArcGISå«æ˜Ÿå½±åƒ</span>
                    </button>
                </div>
            </div>

            <div class="tools-section">
                <h3>å·¥å…·ç®±</h3>
                <div class="tools-group drawing">
                    <h4>ç»˜å›¾å·¥å…·</h4>
                    <div class="draw-buttons-container">
                        <button onclick="startDrawing('Point')" class="draw-button" title="ç»˜åˆ¶ç‚¹">
                            <img src="icon/point.png" alt="ç‚¹">
                            <span>ç»˜åˆ¶ç‚¹</span>
                        </button>
                        <button onclick="startDrawing('LineString')" class="draw-button" title="ç»˜åˆ¶çº¿">
                            <img src="icon/line.png" alt="çº¿">
                            <span>ç»˜åˆ¶çº¿</span>
                        </button>
                        <button onclick="startDrawing('Polygon')" class="draw-button" title="ç»˜åˆ¶é¢">
                            <img src="icon/polygon.png" alt="é¢">
                            <span>ç»˜åˆ¶é¢</span>
                        </button>
                        <button onclick="startDrawing('Circle')" class="draw-button" title="ç»˜åˆ¶åœ†">
                            <img src="icon/circle.png" alt="åœ†">
                            <span>ç»˜åˆ¶åœ†</span>
                        </button>
                        <button onclick="startDrawing('Box')" class="draw-button" title="ç»˜åˆ¶çŸ©å½¢">
                            <img src="icon/rectangle.png" alt="çŸ©å½¢">
                            <span>ç»˜åˆ¶çŸ©å½¢</span>
                        </button>
                    </div>
                    <div class="style-settings">
                        <h5>æ ·å¼è®¾ç½®</h5>
                        <div class="style-options">
                            <div class="style-row">
                                <label>å¡«å……é¢œè‰²</label>
                                <input type="color" id="fillColor" value="#ffffff" onchange="updateDrawStyle()">
                                <input type="range" id="fillOpacity" min="0" max="1" step="0.1" value="0.2" onchange="updateDrawStyle()">
                            </div>
                            <div class="style-row">
                                <label>è¾¹æ¡†é¢œè‰²</label>
                                <input type="color" id="strokeColor" value="#ffcc33" onchange="updateDrawStyle()">
                            </div>
                            <div class="style-row">
                                <label>è¾¹æ¡†å®½åº¦</label>
                                <input type="range" id="strokeWidth" min="1" max="10" value="2" onchange="updateDrawStyle()">
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="tools-group editing">
                    <h4>ç¼–è¾‘å·¥å…·</h4>
                    <div class="tool-buttons">
                        <button onclick="enableEdit()">é€‰æ‹©ç¼–è¾‘</button>
                        <button onclick="deleteSelected()">åˆ é™¤é€‰ä¸­</button>
                        <button onclick="clearDrawings()">æ¸…ç©ºç»˜åˆ¶</button>
                    </div>
                    <div class="features-list">
                        <h5>å·²ç»˜åˆ¶å›¾å½¢</h5>
                        <div id="featuresList" class="features-container">
                            <!-- å›¾å½¢åˆ—è¡¨å°†åœ¨è¿™é‡ŒåŠ¨æ€ç”Ÿæˆ -->
                        </div>
                    </div>
                </div>
                
                <div class="tools-group analysis">
                    <h4>åˆ†æå·¥å…·</h4>
                    <div class="tool-buttons">
                        <button class="analysis-button" title="ç¼“å†²åŒºåˆ†æ">
                            <img src="icon/buffer.png" alt="ç¼“å†²åŒº">
                            <span>ç¼“å†²åŒºåˆ†æ</span>
                        </button>
                        <button class="analysis-button" title="ç›¸äº¤åˆ†æ">
                            <img src="icon/intersect.png" alt="ç›¸äº¤">
                            <span>ç›¸äº¤åˆ†æ</span>
                        </button>
                        <button class="analysis-button" title="åˆå¹¶åˆ†æ">
                            <img src="icon/union.png" alt="åˆå¹¶">
                            <span>åˆå¹¶åˆ†æ</span>
                        </button>
                    </div>
                </div>
                
                <div class="tools-group">
                    <h4>ç©ºé—´æŸ¥è¯¢</h4>
                    <div class="tool-buttons">
                        <button onclick="enableQuery()">ç©ºé—´æŸ¥è¯¢</button>
                        <button onclick="clearQuery()">æ¸…é™¤æŸ¥è¯¢</button>
                    </div>
                </div>
            </div>

            <div class="file-upload-section">
                <h3>åŠ è½½æœ¬åœ°æ–‡ä»¶</h3>
                <div class="file-buttons">
                    <input type="file" id="shpFileInput" accept=".shp,.dbf,.prj,.shx" multiple style="display: none;">
                    <input type="file" id="tifFileInput" accept=".tif,.tiff" multiple style="display: none;">
                    <button class="file-button" onclick="document.getElementById('shpFileInput').click()">
                        <img src="icon/shp.png" alt="Shapefile">
                        <span>åŠ è½½ Shapefile</span>
                    </button>
                    <button class="file-button" onclick="document.getElementById('tifFileInput').click()">
                        <img src="icon/tif.png" alt="GeoTIFF">
                        <span>åŠ è½½ GeoTIFF</span>
                    </button>
                </div>
                <div id="loaded-files" class="loaded-files">
                    <!-- åŠ è½½çš„æ–‡ä»¶åˆ—è¡¨å°†æ˜¾ç¤ºåœ¨è¿™é‡Œ -->
                </div>
            </div>
        </div>
        
        <div id="map">
            <!-- åœ°å›¾å°†åœ¨è¿™é‡Œæ¸²æŸ“ -->
        </div>

        <div id="toolbar">
            <button class="tool-button" title="å¹³ç§»">ğŸ–ï¸</button>
            <button class="tool-button" title="æ”¾å¤§">â•</button>
            <button class="tool-button" title="ç¼©å°">â–</button>
            <button class="tool-button" title="å¤ä½">ğŸ </button>
            <button class="tool-button" title="æµ‹é‡">ğŸ“</button>
            <button class="tool-button" title="æ ‡æ³¨">ğŸ“</button>
        </div>

        <div id="status-bar">
            <span id="coordinates">åæ ‡: å¾…æ›´æ–°</span>
            <span id="scale">æ¯”ä¾‹å°º: å¾…æ›´æ–°</span>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/gh/openlayers/openlayers.github.io@master/en/v6.15.1/build/ol.js"></script>
    <script>
        let map;
        let gaodeLayer;
        let arcgisLayer;
        let draw; // ç”¨äºç»˜åˆ¶åŠŸèƒ½
        let measure; // ç”¨äºæµ‹é‡åŠŸèƒ½
        let localLayers = new Map(); // å­˜å‚¨æœ¬åœ°å›¾å±‚
        
        // å®šä¹‰å…¨å±€å˜é‡
        let drawSource;
        let drawLayer;
        let drawInteraction;
        let modifyInteraction;
        let selectInteraction;
        
        // å½“å‰ç»˜åˆ¶æ ·å¼
        let currentStyle = {
            fill: {
                color: 'rgba(255, 255, 255, 0.2)'
            },
            stroke: {
                color: '#ffcc33',
                width: 2
            },
            image: {
                radius: 7,
                fill: {
                    color: '#ffcc33'
                }
            }
        };
        
        document.addEventListener('DOMContentLoaded', function() {
            try {
                console.log('å¼€å§‹åˆå§‹åŒ–åœ°å›¾...');
                initMap();
                initLayerControls();
                console.log('åœ°å›¾åˆå§‹åŒ–å®Œæˆ');
            } catch (error) {
                console.error('åœ°å›¾åˆå§‹åŒ–å¤±è´¥:', error);
            }
        });

        function initMap() {
            // åˆ›å»ºé«˜å¾·åœ°å›¾ç“¦ç‰‡å›¾å±‚
            gaodeLayer = new ol.layer.Tile({
                source: new ol.source.XYZ({
                    url: 'https://wprd0{1-4}.is.autonavi.com/appmaptile?lang=zh_cn&size=1&style=7&x={x}&y={y}&z={z}',
                    projection: 'EPSG:3857'
                })
            });

            // åˆ›å»ºArcGISå«æ˜Ÿå½±åƒå›¾å±‚
            arcgisLayer = new ol.layer.Tile({
                source: new ol.source.XYZ({
                    url: 'https://server.arcgisonline.com/arcgis/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}',
                    projection: 'EPSG:3857'
                }),
                visible: false
            });

            // åˆ›å»ºåœ°å›¾
            map = new ol.Map({
                target: 'map',
                layers: [gaodeLayer, arcgisLayer],
                view: new ol.View({
                    center: ol.proj.fromLonLat([113.868729, 34.043781]),
                    zoom: 16,
                    maxZoom: 20,
                    minZoom: 1
                }),
                controls: ol.control.defaults().extend([
                    new ol.control.ScaleLine(),
                    new ol.control.ZoomSlider()
                ]),
                interactions: ol.interaction.defaults({
                    mouseWheelZoom: false
                }).extend([
                    new ol.interaction.MouseWheelZoom({
                        duration: 50,
                        timeout: 0,
                        useAnchor: true,
                        constrainResolution: false,
                        maxDelta: 2,
                        smooth: false,
                        trackpad: false
                    })
                ])
            });

            // åˆ›å»ºæˆ–ç¡®ä¿çŠ¶æ€æ å­˜åœ¨
            const statusBar = document.getElementById('status-bar') || document.createElement('div');
            statusBar.id = 'status-bar';
            statusBar.innerHTML = `
                <span id="coordinates">åæ ‡: å¾…æ›´æ–°</span>
                <span id="scale">æ¯”ä¾‹å°º: å¾…æ›´æ–°</span>
            `;
            
            if (!document.getElementById('status-bar')) {
                document.getElementById('container').appendChild(statusBar);
            }

            // ç­‰å¾…åœ°å›¾åŠ è½½å®Œæˆ
            map.once('postrender', function() {
                // åˆå§‹åŒ–ç»˜å›¾å›¾å±‚
                initDrawLayer();

                // æ·»åŠ è§†å›¾å˜åŒ–ç›‘å¬å™¨
                map.getView().on('change:resolution', updateScale);
                map.getView().on('change:center', updateScale);

                // åˆå§‹æ›´æ–°ä¸€æ¬¡æ¯”ä¾‹å°º
                updateScale();

                // æ·»åŠ é¼ æ ‡ç§»åŠ¨ç›‘å¬å™¨æ›´æ–°åæ ‡
                map.on('pointermove', function(evt) {
                    const coords = ol.proj.transform(evt.coordinate, 'EPSG:3857', 'EPSG:4326');
                    document.getElementById('coordinates').textContent = 
                        `åæ ‡: ${coords[0].toFixed(6)}, ${coords[1].toFixed(6)}`;
                });

                initToolbar();
            });

            // å°† map å¯¹è±¡è®¾ä¸ºå…¨å±€å˜é‡
            window.map = map;

            console.log('åœ°å›¾å¯¹è±¡åˆ›å»ºå®Œæˆ');
        }

        function initLayerControls() {
            const buttons = document.querySelectorAll('.layer-button');
            buttons.forEach(button => {
                button.addEventListener('click', function() {
                    const layerType = this.dataset.layer;
                    
                    // ç§»é™¤æ‰€æœ‰æŒ‰é’®çš„activeç±»
                    buttons.forEach(btn => btn.classList.remove('active'));
                    // æ·»åŠ å½“å‰æŒ‰é’®çš„activeç±»
                    this.classList.add('active');
                    
                    switch(layerType) {
                        case 'gaode':
                            gaodeLayer.setVisible(true);
                            arcgisLayer.setVisible(false);
                            break;
                        case 'arcgis':
                            gaodeLayer.setVisible(false);
                            arcgisLayer.setVisible(true);
                            break;
                    }
                });
            });

            // é»˜è®¤æ¿€æ´»é«˜å¾·åœ°å›¾æŒ‰é’®
            buttons[0].classList.add('active');
        }

        // åœ¨åœ°å›¾åˆå§‹åŒ–åæ·»åŠ å·¥å…·æ åˆå§‹åŒ–
        function initToolbar() {
            const toolbar = document.createElement('div');
            toolbar.id = 'toolbar';
            toolbar.innerHTML = `
                <button class="tool-button" title="å¹³ç§»">ğŸ–ï¸</button>
                <button class="tool-button" title="æ”¾å¤§">â•</button>
                <button class="tool-button" title="ç¼©å°">â–</button>
                <button class="tool-button" title="å¤ä½">ğŸ </button>
                <button class="tool-button" title="æµ‹é‡">ğŸ“</button>
                <button class="tool-button" title="æ ‡æ³¨">ğŸ“</button>
            `;
            document.getElementById('container').appendChild(toolbar);

            // ä¸ºæŒ‰é’®æ·»åŠ äº‹ä»¶ç›‘å¬
            const buttons = toolbar.querySelectorAll('.tool-button');
            let activeButton = null;  // è®°å½•å½“å‰æ¿€æ´»çš„æŒ‰é’®
            let lastClickTime = 0;    // è®°å½•ä¸Šæ¬¡ç‚¹å‡»æ—¶é—´

            buttons.forEach(button => {
                button.addEventListener('click', function(e) {
                    const currentTime = new Date().getTime();
                    const timeDiff = currentTime - lastClickTime;
                    
                    // æ£€æŸ¥æ˜¯å¦æ˜¯åŒå‡»ï¼ˆæ—¶é—´é—´éš”å°äº300msï¼‰
                    if (timeDiff < 300 && this === activeButton) {
                        // åŒå‡»å½“å‰æ¿€æ´»çš„æŒ‰é’®ï¼Œå…³é—­åŠŸèƒ½
                        this.classList.remove('active');
                        clearInteractions();
                        activeButton = null;
                        lastClickTime = 0;
                        return;
                    }
                    
                    lastClickTime = currentTime;

                    // å¦‚æœç‚¹å‡»çš„æ˜¯å½“å‰æ¿€æ´»çš„æŒ‰é’®ï¼Œä¸åšä»»ä½•æ“ä½œ
                    if (this === activeButton) {
                        return;
                    }

                    // ç§»é™¤æ‰€æœ‰æŒ‰é’®çš„activeçŠ¶æ€
                    buttons.forEach(btn => btn.classList.remove('active'));
                    
                    // æ¸…é™¤ä¹‹å‰çš„äº¤äº’
                    clearInteractions();
                    
                    // æ¿€æ´»æ–°åŠŸèƒ½
                    switch(this.title) {
                        case 'å¹³ç§»':
                            enablePan();
                            this.classList.add('active');
                            break;
                        case 'æ”¾å¤§':
                            enableZoomIn();
                            break;  // æ”¾å¤§ç¼©å°ä¸éœ€è¦ä¿æŒæ¿€æ´»çŠ¶æ€
                        case 'ç¼©å°':
                            enableZoomOut();
                            break;  // æ”¾å¤§ç¼©å°ä¸éœ€è¦ä¿æŒæ¿€æ´»çŠ¶æ€
                        case 'å¤ä½':
                            resetView();
                            break;  // å¤ä½ä¸éœ€è¦ä¿æŒæ¿€æ´»çŠ¶æ€
                        case 'æµ‹é‡':
                            enableMeasure();
                            this.classList.add('active');
                            break;
                        case 'æ ‡æ³¨':
                            enableMarker();
                            this.classList.add('active');
                            break;
                    }
                    
                    // æ›´æ–°å½“å‰æ¿€æ´»çš„æŒ‰é’®ï¼ˆé™¤äº†æ”¾å¤§ã€ç¼©å°å’Œå¤ä½ï¼‰
                    activeButton = ['æ”¾å¤§', 'ç¼©å°', 'å¤ä½'].includes(this.title) ? null : this;
                });
            });
        }

        // æ·»åŠ å·¥å…·æ åŠŸèƒ½å‡½æ•°
        function enablePan() {
            clearInteractions();
            map.getView().setRotation(0);
        }

        function enableZoomIn() {
            clearInteractions();
            map.getView().animate({
                zoom: map.getView().getZoom() + 1,
                duration: 250
            });
        }

        function enableZoomOut() {
            clearInteractions();
            map.getView().animate({
                zoom: map.getView().getZoom() - 1,
                duration: 250
            });
        }

        function enableHome() {
            clearInteractions();
            map.getView().animate({
                center: ol.proj.fromLonLat([116.397428, 39.90923]),
                zoom: 12,
                duration: 1000
            });
        }

        function enableMeasure() {
            clearInteractions();
            
            // åˆ›å»ºæµ‹é‡ç»˜å›¾äº¤äº’
            const measureDraw = new ol.interaction.Draw({
                source: drawSource,
                type: 'LineString',
                style: new ol.style.Style({
                    fill: new ol.style.Fill({
                        color: 'rgba(255, 255, 255, 0.2)'
                    }),
                    stroke: new ol.style.Stroke({
                        color: '#ffcc33',
                        width: 2
                    }),
                    image: new ol.style.Circle({
                        radius: 7,
                        fill: new ol.style.Fill({
                            color: '#ffcc33'
                        })
                    })
                })
            });

            // æ·»åŠ æµ‹é‡æç¤º
            let measureTooltipElement;
            let measureTooltip;

            function createMeasureTooltip() {
                if (measureTooltipElement) {
                    measureTooltipElement.parentNode.removeChild(measureTooltipElement);
                }
                measureTooltipElement = document.createElement('div');
                measureTooltipElement.className = 'tooltip tooltip-measure';
                measureTooltip = new ol.Overlay({
                    element: measureTooltipElement,
                    offset: [0, -15],
                    positioning: 'bottom-center'
                });
                map.addOverlay(measureTooltip);
            }

            createMeasureTooltip();

            // ç›‘å¬ç»˜å›¾äº‹ä»¶
            let sketch;
            measureDraw.on('drawstart', function(evt) {
                sketch = evt.feature;
                let tooltipCoord = evt.coordinate;

                sketch.getGeometry().on('change', function(evt) {
                    const geom = evt.target;
                    let output = formatLength(geom);
                    tooltipCoord = geom.getLastCoordinate();
                    measureTooltipElement.innerHTML = output;
                    measureTooltip.setPosition(tooltipCoord);
                });
            });

            measureDraw.on('drawend', function() {
                measureTooltipElement.className = 'tooltip tooltip-static';
                measureTooltip.setOffset([0, -7]);
                sketch = null;
                createMeasureTooltip();
            });

            map.addInteraction(measureDraw);
        }

        // ä¿®æ”¹ enableMarker å‡½æ•°
        function enableMarker() {
            clearInteractions();
            
            const markerDraw = new ol.interaction.Draw({
                source: drawSource,
                type: 'Point',
                style: new ol.style.Style({
                    image: new ol.style.Circle({
                        radius: 6,
                        fill: new ol.style.Fill({
                            color: '#4CAF50'
                        }),
                        stroke: new ol.style.Stroke({
                            color: 'white',
                            width: 2
                        })
                    })
                })
            });

            markerDraw.on('drawend', function(evt) {
                const feature = evt.feature;
                const coord = feature.getGeometry().getCoordinates();
                
                // åˆ›å»ºæ ‡æ³¨å¯¹è¯æ¡†
                const markerDialog = document.createElement('div');
                markerDialog.className = 'marker-tooltip';
                markerDialog.innerHTML = `
                    <input type="text" id="markerText" placeholder="è¯·è¾“å…¥æ ‡æ³¨å†…å®¹" autofocus>
                    <button id="markerSubmit">ç¡®å®š</button>
                `;
                
                const overlay = new ol.Overlay({
                    element: markerDialog,
                    position: coord,
                    positioning: 'bottom-center',
                    offset: [0, -10],
                    stopEvent: false
                });
                
                map.addOverlay(overlay);
                
                // è‡ªåŠ¨èšç„¦è¾“å…¥æ¡†å¹¶æ·»åŠ äº‹ä»¶ç›‘å¬
                setTimeout(() => {
                    const input = document.getElementById('markerText');
                    const submitButton = document.getElementById('markerSubmit');
                    
                    if (input && submitButton) {
                        input.focus();
                        
                        const handleSubmit = () => {
                            const text = input.value.trim();
                            if (text) {
                                // åˆ›å»ºæ ‡æ³¨è¦ç´ 
                                const markerFeature = new ol.Feature({
                                    geometry: new ol.geom.Point(coord)
                                });

                                // è®¾ç½®æ ‡æ³¨æ ·å¼
                                markerFeature.setStyle(new ol.style.Style({
                                    image: new ol.style.Circle({
                                        radius: 6,
                                        fill: new ol.style.Fill({
                                            color: '#4CAF50'
                                        }),
                                        stroke: new ol.style.Stroke({
                                            color: 'white',
                                            width: 2
                                        })
                                    }),
                                    text: new ol.style.Text({
                                        text: text,
                                        offsetY: -15,
                                        fill: new ol.style.Fill({
                                            color: '#333'
                                        }),
                                        stroke: new ol.style.Stroke({
                                            color: 'white',
                                            width: 3
                                        }),
                                        font: '12px sans-serif'
                                    })
                                }));

                                // æ·»åŠ åˆ°å›¾å±‚
                                drawSource.addFeature(markerFeature);

                                // ç§»é™¤æ ‡æ³¨å¯¹è¯æ¡†
                                const overlays = map.getOverlays().getArray();
                                overlays.slice().forEach(overlay => {
                                    const element = overlay.getElement();
                                    if (element && element.classList.contains('marker-tooltip')) {
                                        map.removeOverlay(overlay);
                                    }
                                });

                                // æ›´æ–°è¦ç´ åˆ—è¡¨
                                updateFeaturesList();
                            }
                        };

                        // æ·»åŠ å›è½¦é”®ç›‘å¬
                        input.addEventListener('keypress', function(e) {
                            if (e.key === 'Enter') {
                                handleSubmit();
                            }
                        });

                        // æ·»åŠ æŒ‰é’®ç‚¹å‡»ç›‘å¬
                        submitButton.addEventListener('click', handleSubmit);
                    }
                }, 100);

                // ç§»é™¤ä¸´æ—¶ç‚¹è¦ç´ 
                drawSource.removeFeature(feature);
            });

            map.addInteraction(markerDraw);
        }

        // ä¿®æ”¹ createMarkerLabel å‡½æ•°
        function createMarkerLabel(x, y) {
            try {
                const text = document.getElementById('markerText').value.trim();
                if (!text) {
                    alert('è¯·è¾“å…¥æ ‡æ³¨å†…å®¹');
                    return;
                }

                // åˆ›å»ºæ ‡æ³¨è¦ç´ 
                const feature = new ol.Feature({
                    geometry: new ol.geom.Point([parseFloat(x), parseFloat(y)])
                });

                // è®¾ç½®æ ‡æ³¨æ ·å¼
                feature.setStyle(new ol.style.Style({
                    image: new ol.style.Circle({
                        radius: 6,
                        fill: new ol.style.Fill({
                            color: '#4CAF50'
                        }),
                        stroke: new ol.style.Stroke({
                            color: 'white',
                            width: 2
                        })
                    }),
                    text: new ol.style.Text({
                        text: text,
                        offsetY: -15,
                        fill: new ol.style.Fill({
                            color: '#333'
                        }),
                        stroke: new ol.style.Stroke({
                            color: 'white',
                            width: 3
                        }),
                        font: '12px sans-serif'
                    })
                }));

                // æ·»åŠ åˆ°å›¾å±‚
                drawSource.addFeature(feature);

                // ç§»é™¤æ ‡æ³¨å¯¹è¯æ¡†
                const overlays = map.getOverlays().getArray();
                overlays.slice().forEach(overlay => {
                    const element = overlay.getElement();
                    if (element && element.classList.contains('marker-tooltip')) {
                        map.removeOverlay(overlay);
                    }
                });

                // æ›´æ–°è¦ç´ åˆ—è¡¨
                updateFeaturesList();

            } catch (error) {
                console.error('åˆ›å»ºæ ‡æ³¨æ—¶å‡ºé”™:', error);
                alert('åˆ›å»ºæ ‡æ³¨æ—¶å‡ºé”™: ' + error.message);
            }
        }

        // è¾…åŠ©å‡½æ•°ï¼šæ ¼å¼åŒ–é•¿åº¦
        function formatLength(line) {
            const length = ol.sphere.getLength(line);
            let output;
            if (length > 1000) {
                output = (Math.round(length / 1000 * 100) / 100) + ' km';
            } else {
                output = (Math.round(length * 100) / 100) + ' m';
            }
            return output;
        }

        // ä¿®æ”¹ clearInteractions å‡½æ•°
        function clearInteractions() {
            // ç§»é™¤æµ‹é‡å’Œæ ‡æ³¨ç›¸å…³çš„å›¾å±‚
            map.getLayers().getArray()
                .filter(layer => layer instanceof ol.layer.Vector && layer !== drawLayer)  // ä¿ç•™ç»˜å›¾å›¾å±‚
                .forEach(layer => map.removeLayer(layer));
            
            // ç§»é™¤æ‰€æœ‰overlayï¼ˆæµ‹é‡æç¤ºå’Œæ ‡æ³¨ï¼‰
            const overlays = map.getOverlays().getArray();
            overlays.slice().forEach(overlay => {
                const element = overlay.getElement();
                if (element && (
                    element.classList.contains('marker-tooltip') || 
                    element.classList.contains('tooltip')
                )) {
                    map.removeOverlay(overlay);
                }
            });
            
            // ç§»é™¤äº¤äº’
            if (measure) map.removeInteraction(measure);
            if (draw) map.removeInteraction(draw);
            if (drawInteraction) {
                map.removeInteraction(drawInteraction);
                drawInteraction = null;
            }
            if (selectInteraction) {
                map.removeInteraction(selectInteraction);
                selectInteraction = null;
            }
            if (modifyInteraction) {
                map.removeInteraction(modifyInteraction);
                modifyInteraction = null;
            }

            map.getInteractions().forEach(interaction => {
                if (interaction instanceof ol.interaction.DragZoom || 
                    interaction instanceof ol.interaction.Draw) {
                    map.removeInteraction(interaction);
                }
            });
            
            // é‡ç½®å˜é‡
            measure = null;
            draw = null;

            // ç§»é™¤æ‰€æœ‰æŒ‰é’®çš„æ¿€æ´»çŠ¶æ€
            document.querySelectorAll('.tool-button').forEach(btn => {
                btn.classList.remove('active');
            });
        }

        // æ·»åŠ æ–‡ä»¶è¾“å…¥ç›‘å¬å™¨
        document.addEventListener('DOMContentLoaded', function() {
            // Shapefile æ–‡ä»¶è¾“å…¥ç›‘å¬
            const shpFileInput = document.getElementById('shpFileInput');
            shpFileInput.addEventListener('change', async function(event) {
                try {
                    const files = Array.from(event.target.files);
                    
                    // å¤„ç† Shapefile æ–‡ä»¶
                    const shpFile = files.find(f => f.name.toLowerCase().endsWith('.shp'));
                    const dbfFile = files.find(f => f.name.toLowerCase().endsWith('.dbf'));
                    if (shpFile && dbfFile) {
                        // è¯»å–æ–‡ä»¶å†…å®¹
                        const [shpBuffer, dbfBuffer] = await Promise.all([
                            readFileAsArrayBuffer(shpFile),
                            readFileAsArrayBuffer(dbfFile)
                        ]);

                        // è§£æ Shapefile
                        const geojson = await shp.combine([
                            await shp.parseShp(shpBuffer),
                            await shp.parseDbf(dbfBuffer)
                        ]);

                        // åˆ›å»ºçŸ¢é‡å›¾å±‚
                        const format = new ol.format.GeoJSON();
                        const features = format.readFeatures(geojson, {
                            dataProjection: 'EPSG:4326',
                            featureProjection: map.getView().getProjection()
                        });

                        const vectorSource = new ol.source.Vector({
                            features: features
                        });

                        const vectorLayer = new ol.layer.Vector({
                            source: vectorSource,
                            style: new ol.style.Style({
                                fill: new ol.style.Fill({
                                    color: 'rgba(255, 255, 255, 0.2)'
                                }),
                                stroke: new ol.style.Stroke({
                                    color: '#ffcc33',
                                    width: 2
                                })
                            })
                        });

                        // æ·»åŠ å›¾å±‚åˆ°åœ°å›¾
                        map.addLayer(vectorLayer);
                        localLayers.set(shpFile.name, vectorLayer);
                        updateFilesList(); // æ·»åŠ è¿™è¡Œ

                        // ç¼©æ”¾åˆ°å›¾å±‚èŒƒå›´
                        if (vectorSource.getFeatures().length > 0) {
                            const extent = vectorSource.getExtent();
                            map.getView().fit(extent, {
                                padding: [50, 50, 50, 50],
                                duration: 0
                            });
                        }
                    }
                } catch (error) {
                    console.error('å¤„ç† Shapefile å¤±è´¥:', error);
                    alert('å¤„ç† Shapefile å¤±è´¥: ' + error.message);
                }
            });

            // GeoTIFF æ–‡ä»¶è¾“å…¥ç›‘å¬
            const tifFileInput = document.getElementById('tifFileInput');
            tifFileInput.addEventListener('change', async function(event) {
                try {
                    const files = Array.from(event.target.files);
                    for (const tifFile of files) {
                        await loadGeoTiff(tifFile);
                    }
                } catch (error) {
                    console.error('å¤„ç† GeoTIFF å¤±è´¥:', error);
                    alert('å¤„ç† GeoTIFF å¤±è´¥: ' + error.message);
                }
            });
        });

        // è¯»å–æ–‡ä»¶ä¸º ArrayBuffer
        function readFileAsArrayBuffer(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = e => resolve(e.target.result);
                reader.onerror = () => reject(new Error('è¯»å–æ–‡ä»¶å¤±è´¥'));
                reader.readAsArrayBuffer(file);
            });
        }

        // ç¡®ä¿æ­£ç¡®å¼•å…¥ shp.js
        function initShpSupport() {
            const script = document.createElement('script');
            script.src = 'https://unpkg.com/shpjs@latest/dist/shp.js';
            script.onload = function() {
                console.log('shp.js åŠ è½½æˆåŠŸ');
            };
            script.onerror = function() {
                console.error('shp.js åŠ è½½å¤±è´¥');
                alert('åŠ è½½ Shapefile æ”¯æŒåº“å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥');
            };
            document.head.appendChild(script);
        }

        // åœ¨é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ– shp.js
        document.addEventListener('DOMContentLoaded', function() {
            initShpSupport();
        });

        async function loadGeoTiff(file) {
            try {
                const arrayBuffer = await readFileAsArrayBuffer(file);
                const tiff = await GeoTIFF.fromArrayBuffer(arrayBuffer);
                const image = await tiff.getImage();
                
                // è·å–å›¾åƒä¿¡æ¯
                const width = image.getWidth();
                const height = image.getHeight();
                const [minX, minY, maxX, maxY] = image.getBoundingBox();
                
                // åˆ›å»ºç”»å¸ƒ
                const canvas = document.createElement('canvas');
                canvas.width = width;
                canvas.height = height;
                const ctx = canvas.getContext('2d');
                const imageData = ctx.createImageData(width, height);

                // åˆ†å—è¯»å–æ•°æ®
                const CHUNK_SIZE = 1000; // æ¯æ¬¡å¤„ç†çš„è¡Œæ•°
                const bands = (await image.getSamplesPerPixel());

                for (let startRow = 0; startRow < height; startRow += CHUNK_SIZE) {
                    const endRow = Math.min(startRow + CHUNK_SIZE, height);
                    const window = [0, startRow, width, endRow];
                    
                    const data = await image.readRasters({
                        window: window,
                        samples: bands >= 3 ? [0, 1, 2] : [0]
                    });

                    // å¤„ç†è¿™ä¸€å—æ•°æ®
                    for (let i = 0; i < endRow - startRow; i++) {
                        for (let j = 0; j < width; j++) {
                            const pixelIndex = ((startRow + i) * width + j) * 4;
                            const dataIndex = i * width + j;

                            if (bands >= 3) {
                                // RGBæ˜¾ç¤º
                                imageData.data[pixelIndex] = data[0][dataIndex];     // R
                                imageData.data[pixelIndex + 1] = data[1][dataIndex]; // G
                                imageData.data[pixelIndex + 2] = data[2][dataIndex]; // B
                            } else {
                                // ç°åº¦æ˜¾ç¤º
                                const value = data[0][dataIndex];
                                imageData.data[pixelIndex] = value;
                                imageData.data[pixelIndex + 1] = value;
                                imageData.data[pixelIndex + 2] = value;
                            }
                            imageData.data[pixelIndex + 3] = 255; // Alpha
                        }
                    }
                }

                ctx.putImageData(imageData, 0, 0);

                // åˆ›å»ºå›¾å±‚
                const extent = [minX, minY, maxX, maxY];
                const imageLayer = new ol.layer.Image({
                    source: new ol.source.ImageStatic({
                        url: canvas.toDataURL(),
                        imageExtent: extent,
                        projection: 'EPSG:4326'
                    }),
                    opacity: 1
                });

                // æ·»åŠ å›¾å±‚å¹¶ç«‹å³æ˜¾ç¤º
                map.addLayer(imageLayer);
                localLayers.set(file.name, imageLayer);
                updateFilesList(); // æ·»åŠ è¿™è¡Œ

                // è½¬æ¢å¹¶è®¾ç½®è§†å›¾èŒƒå›´ï¼Œä¸ä½¿ç”¨åŠ¨ç”»
                const transformedExtent = ol.proj.transformExtent(
                    extent,
                    'EPSG:4326',
                    'EPSG:3857'
                );
                map.getView().fit(transformedExtent, {
                    padding: [50, 50, 50, 50],
                    duration: 0  // è®¾ç½®ä¸º0ç§»é™¤åŠ¨ç”»
                });

            } catch (error) {
                console.error('è§£æ GeoTIFF å¤±è´¥:', error);
                alert('è§£æ GeoTIFF å¤±è´¥: ' + error.message);
            }
        }

        // æ›´æ–°æ–‡ä»¶åˆ—è¡¨æ˜¾ç¤º
        function updateFilesList() {
            const filesList = document.getElementById('loaded-files');
            if (!filesList) return;

            let filesHtml = '';
            localLayers.forEach((layer, name) => {
                const isShp = name.toLowerCase().endsWith('.shp');
                const isTif = name.toLowerCase().endsWith('.tif') || name.toLowerCase().endsWith('.tiff');
                
                filesHtml += `
                    <div class="file-item">
                        <img class="file-type-icon" src="icon/${isShp ? 'shp' : 'tif'}.png" 
                             alt="${isShp ? 'Shapefile' : 'GeoTIFF'}">
                        <span class="file-name">${name}</span>
                        <div class="file-controls">
                            <button onclick="toggleLayerVisibility('${name}')" 
                                    title="${layer.getVisible() ? 'éšè—' : 'æ˜¾ç¤º'}">
                                ${layer.getVisible() ? 'ğŸ‘ï¸' : 'ğŸ‘ï¸â€ğŸ—¨ï¸'}
                            </button>
                            <button onclick="removeLayer('${name}')" title="åˆ é™¤">Ã—</button>
                        </div>
                    </div>
                `;
            });

            filesList.innerHTML = filesHtml || '<div class="no-files">æš‚æ— åŠ è½½çš„æ–‡ä»¶</div>';
        }

        // ä¿®æ”¹æ–‡ä»¶å¤„ç†å‡½æ•°ï¼Œåœ¨æ·»åŠ å›¾å±‚åæ›´æ–°æ–‡ä»¶åˆ—è¡¨
        function handleShapefile(shpFile, dbfFile) {
            // ... ç°æœ‰ä»£ç  ...
            
            // æ·»åŠ åˆ°åœ°å›¾åæ›´æ–°æ–‡ä»¶åˆ—è¡¨
            map.addLayer(vectorLayer);
            localLayers.set(shpFile.name, vectorLayer);
            updateFilesList(); // æ·»åŠ è¿™è¡Œ
        }

        // ä¿®æ”¹å›¾å±‚åˆ é™¤å‡½æ•°
        function removeLayer(layerName) {
            const layer = localLayers.get(layerName);
            if (layer) {
                map.removeLayer(layer);
                localLayers.delete(layerName);
                updateFilesList(); // æ›´æ–°æ–‡ä»¶åˆ—è¡¨
            }
        }

        // æ·»åŠ ä¸€ä¸ªé€šç”¨çš„å›¾å±‚ç‚¹å‡»äº‹ä»¶å¤„ç†å‡½æ•°
        function addLayerClickHandler(layer, fileName) {
            const fileList = document.getElementById('fileList');
            const items = fileList.getElementsByClassName('file-item');
            for (let item of items) {
                if (item.firstElementChild.textContent === fileName) {
                    item.addEventListener('click', function(e) {
                        // å¦‚æœç‚¹å‡»çš„æ˜¯åˆ é™¤æŒ‰é’®ï¼Œä¸æ‰§è¡Œç¼©æ”¾
                        if (e.target.tagName === 'BUTTON') return;
                        
                        // è·å–å›¾å±‚èŒƒå›´å¹¶ç¼©æ”¾
                        if (layer instanceof ol.layer.Vector) {
                            const extent = layer.getSource().getExtent();
                            map.getView().fit(extent, {
                                padding: [50, 50, 50, 50],
                                duration: 1000
                            });
                        } else if (layer instanceof ol.layer.Image) {
                            const source = layer.getSource();
                            const extent = source.getImageExtent();
                            const transformedExtent = ol.proj.transformExtent(
                                extent,
                                'EPSG:4326',
                                'EPSG:3857'
                            );
                            map.getView().fit(transformedExtent, {
                                padding: [50, 50, 50, 50],
                                duration: 1000
                            });
                        }
                    });
                }
            }
        }

        // åˆå§‹åŒ–ç»˜å›¾å›¾å±‚
        function initDrawLayer() {
            drawSource = new ol.source.Vector();
            drawLayer = new ol.layer.Vector({
                source: drawSource,
                style: new ol.style.Style({
                    fill: new ol.style.Fill({
                        color: 'rgba(255, 255, 255, 0.2)'
                    }),
                    stroke: new ol.style.Stroke({
                        color: '#ffcc33',
                        width: 2
                    }),
                    image: new ol.style.Circle({
                        radius: 7,
                        fill: new ol.style.Fill({
                            color: '#ffcc33'
                        })
                    })
                })
            });
            map.addLayer(drawLayer);
        }

        // ä¿®æ”¹ startDrawing å‡½æ•°
        function startDrawing(type) {
            let lastClickTime = 0;
            const button = document.querySelector(`button[onclick="startDrawing('${type}')"]`);
            const currentTime = new Date().getTime();
            
            // æ£€æŸ¥æ˜¯å¦æ˜¯åŒå‡»ï¼ˆæ—¶é—´é—´éš”å°äº300msï¼‰
            if (button.classList.contains('active') && currentTime - lastClickTime < 300) {
                // åŒå‡»æ—¶å…³é—­ç»˜å›¾åŠŸèƒ½
                clearInteractions();
                button.classList.remove('active');
                return;
            }
            
            lastClickTime = currentTime;

            // æ¸…é™¤ä¹‹å‰çš„äº¤äº’
            clearInteractions();
            
            // ç§»é™¤æ‰€æœ‰æŒ‰é’®çš„æ¿€æ´»çŠ¶æ€
            document.querySelectorAll('.draw-button').forEach(btn => {
                btn.classList.remove('active');
            });

            // æ¿€æ´»å½“å‰æŒ‰é’®
            button.classList.add('active');

            // å¤„ç†çŸ©å½¢ç»˜åˆ¶
            let geometryType = type;
            let geometryFunction;
            
            if (type === 'Box') {
                geometryType = 'Circle';
                geometryFunction = ol.interaction.Draw.createBox();
            }

            // åˆ›å»ºç»˜å›¾äº¤äº’
            draw = new ol.interaction.Draw({
                source: drawSource,
                type: geometryType,
                geometryFunction: geometryFunction,
                style: new ol.style.Style({
                    fill: new ol.style.Fill({
                        color: 'rgba(255, 255, 255, 0.2)'
                    }),
                    stroke: new ol.style.Stroke({
                        color: '#ffcc33',
                        width: 2
                    }),
                    image: new ol.style.Circle({
                        radius: 7,
                        fill: new ol.style.Fill({
                            color: '#ffcc33'
                        })
                    })
                })
            });

            // æ·»åŠ ç»˜å›¾å®Œæˆäº‹ä»¶ç›‘å¬
            draw.on('drawend', function(evt) {
                // è®¾ç½®é»˜è®¤æ ·å¼
                evt.feature.setStyle(new ol.style.Style({
                    fill: new ol.style.Fill({
                        color: 'rgba(255, 255, 255, 0.2)'
                    }),
                    stroke: new ol.style.Stroke({
                        color: '#ffcc33',
                        width: 2
                    }),
                    image: new ol.style.Circle({
                        radius: 7,
                        fill: new ol.style.Fill({
                            color: '#ffcc33'
                        })
                    })
                }));
                
                // æ›´æ–°è¦ç´ åˆ—è¡¨
                updateFeaturesList();
            });

            map.addInteraction(draw);
        }

        // å¯ç”¨ç¼–è¾‘åŠŸèƒ½
        function enableEdit() {
            clearInteractions();
            
            // åˆ›å»ºé€‰æ‹©äº¤äº’ï¼Œå…è®¸å¤šé€‰
            selectInteraction = new ol.interaction.Select({
                layers: [drawLayer],
                multi: true,  // å…è®¸å¤šé€‰
                toggleCondition: ol.events.condition.shiftKeyOnly  // ä½¿ç”¨Shifté”®è¿›è¡Œå¤šé€‰
            });

            map.addInteraction(selectInteraction);

            // åˆ›å»ºä¿®æ”¹äº¤äº’
            modifyInteraction = new ol.interaction.Modify({
                features: selectInteraction.getFeatures()
            });
            map.addInteraction(modifyInteraction);

            // æ·»åŠ é€‰æ‹©å˜åŒ–äº‹ä»¶ç›‘å¬å™¨
            selectInteraction.on('select', function(e) {
                console.log('é€‰æ‹©è¦ç´ å˜åŒ–:', e.selected.length, 'ä¸ªè¦ç´ è¢«é€‰ä¸­');
            });
        }

        // åˆ é™¤é€‰ä¸­çš„è¦ç´ 
        function deleteSelected() {
            if (!selectInteraction) return;
            const features = selectInteraction.getFeatures();
            features.forEach(feature => {
                drawSource.removeFeature(feature);
            });
            features.clear();
            updateFeaturesList();
        }

        // æ¸…ç©ºæ‰€æœ‰ç»˜åˆ¶çš„è¦ç´ 
        function clearDrawings() {
            if (drawSource) {
                drawSource.clear();
                updateFeaturesList();
            }
        }

        // æ›´æ–°ç»˜åˆ¶æ ·å¼
        function updateDrawStyle() {
            const fillColor = document.getElementById('fillColor').value;
            const fillOpacity = document.getElementById('fillOpacity').value;
            const strokeColor = document.getElementById('strokeColor').value;
            const strokeWidth = document.getElementById('strokeWidth').value;

            // æ›´æ–°å½“å‰æ ·å¼
            currentStyle = {
                fill: {
                    color: hexToRgba(fillColor, fillOpacity)
                },
                stroke: {
                    color: strokeColor,
                    width: parseInt(strokeWidth)
                },
                image: {
                    radius: 7,
                    fill: {
                        color: strokeColor
                    }
                }
            };

            // æ›´æ–°ç»˜å›¾å›¾å±‚çš„æ ·å¼
            if (drawLayer) {
                drawLayer.setStyle(new ol.style.Style({
                    fill: new ol.style.Fill(currentStyle.fill),
                    stroke: new ol.style.Stroke(currentStyle.stroke),
                    image: new ol.style.Circle({
                        radius: currentStyle.image.radius,
                        fill: new ol.style.Fill(currentStyle.image.fill)
                    })
                }));
            }
        }

        // è¾…åŠ©å‡½æ•°ï¼šå°†åå…­è¿›åˆ¶é¢œè‰²è½¬æ¢ä¸º rgba
        function hexToRgba(hex, opacity) {
            // ç§»é™¤ # å·ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
            hex = hex.replace('#', '');
            
            // è§£æ RGB å€¼
            const r = parseInt(hex.substring(0, 2), 16);
            const g = parseInt(hex.substring(2, 4), 16);
            const b = parseInt(hex.substring(4, 6), 16);
            
            // è¿”å› rgba æ ¼å¼çš„é¢œè‰²å­—ç¬¦ä¸²
            return `rgba(${r}, ${g}, ${b}, ${opacity})`;
        }

        // æ›´æ–°è¦ç´ åˆ—è¡¨
        function updateFeaturesList() {
            const featuresList = document.getElementById('featuresList');
            featuresList.innerHTML = '';
            
            const features = drawSource.getFeatures();
            features.forEach((feature, index) => {
                const geometry = feature.getGeometry();
                const type = geometry.getType();
                
                const featureItem = document.createElement('div');
                featureItem.className = 'feature-item';
                featureItem.innerHTML = `
                    <div class="feature-icon">
                        <img src="icon/${getGeometryIcon(type)}" alt="${type}">
                    </div>
                    <div class="feature-name">${getGeometryName(type)} ${index + 1}</div>
                    <div class="feature-actions">
                        <button class="zoom-btn" data-index="${index}" title="ç¼©æ”¾è‡³">
                            <img src="icon/zoom.png" alt="ç¼©æ”¾" width="12">
                        </button>
                        <button class="download-btn" data-index="${index}" title="ä¸‹è½½KML">
                            <img src="icon/download.png" alt="ä¸‹è½½" width="12">
                        </button>
                        <button class="delete-btn" data-index="${index}" title="åˆ é™¤">
                            <img src="icon/delete.png" alt="åˆ é™¤" width="12">
                        </button>
                    </div>
                `;
                
                // æ·»åŠ ç‚¹å‡»äº‹ä»¶ä»¥é€‰æ‹©è¦ç´ 
                featureItem.addEventListener('click', (e) => {
                    // æ£€æŸ¥æ˜¯å¦ç‚¹å‡»äº†æŒ‰é’®
                    if (!e.target.closest('button')) {
                        selectFeature(feature);
                        updateFeatureSelection(featureItem);
                    }
                });

                // ä¸ºæŒ‰é’®æ·»åŠ å•ç‹¬çš„äº‹ä»¶ç›‘å¬å™¨
                featureItem.querySelector('.zoom-btn').addEventListener('click', (e) => {
                    e.stopPropagation(); // é˜»æ­¢äº‹ä»¶å†’æ³¡
                    const index = parseInt(e.currentTarget.dataset.index);
                    zoomToFeature(index);
                });

                featureItem.querySelector('.delete-btn').addEventListener('click', (e) => {
                    e.stopPropagation(); // é˜»æ­¢äº‹ä»¶å†’æ³¡
                    const index = parseInt(e.currentTarget.dataset.index);
                    deleteFeature(index);
                });

                // æ·»åŠ ä¸‹è½½æŒ‰é’®çš„äº‹ä»¶ç›‘å¬å™¨
                featureItem.querySelector('.download-btn').addEventListener('click', (e) => {
                    e.stopPropagation();
                    const index = parseInt(e.currentTarget.dataset.index);
                    downloadFeatureAsKML(index);
                });
                
                featuresList.appendChild(featureItem);
            });
        }

        // è·å–å‡ ä½•ç±»å‹å¯¹åº”çš„å›¾æ ‡
        function getGeometryIcon(type) {
            switch (type) {
                case 'Point': return 'point.png';
                case 'LineString': return 'line.png';
                case 'Polygon': return 'polygon.png';
                case 'Circle': return 'circle.png';
                default: return 'shape.png';
            }
        }

        // è·å–å‡ ä½•ç±»å‹çš„ä¸­æ–‡åç§°
        function getGeometryName(type) {
            switch (type) {
                case 'Point': return 'ç‚¹';
                case 'LineString': return 'çº¿';
                case 'Polygon': return 'é¢';
                case 'Circle': return 'åœ†';
                default: return 'å›¾å½¢';
            }
        }

        // ç¼©æ”¾åˆ°æŒ‡å®šè¦ç´ 
        function zoomToFeature(index) {
            const features = drawSource.getFeatures();
            if (features[index]) {
                const extent = features[index].getGeometry().getExtent();
                map.getView().fit(extent, {
                    padding: [50, 50, 50, 50],
                    duration: 500
                });
            }
        }

        // åˆ é™¤æŒ‡å®šè¦ç´ 
        function deleteFeature(index) {
            const features = drawSource.getFeatures();
            if (features[index]) {
                drawSource.removeFeature(features[index]);
                updateFeaturesList();
            }
        }

        // é€‰æ‹©è¦ç´ 
        function selectFeature(feature) {
            if (selectInteraction) {
                selectInteraction.getFeatures().clear();
                selectInteraction.getFeatures().push(feature);
            }
        }

        // æ›´æ–°è¦ç´ é€‰æ‹©çŠ¶æ€çš„è§†è§‰æ•ˆæœ
        function updateFeatureSelection(selectedItem) {
            document.querySelectorAll('.feature-item').forEach(item => {
                item.classList.remove('selected');
            });
            selectedItem.classList.add('selected');
        }

        // æ·»åŠ ä¸‹è½½KMLçš„åŠŸèƒ½
        function downloadFeatureAsKML(index) {
            const features = drawSource.getFeatures();
            if (features[index]) {
                const feature = features[index];
                const geometry = feature.getGeometry();
                const type = geometry.getType();
                
                // åˆ›å»ºKMLæ ¼å¼åŒ–å™¨
                const format = new ol.format.KML({
                    extractStyles: true,
                    showPointNames: true
                });
                
                // è½¬æ¢è¦ç´ ä¸ºKML
                const kml = format.writeFeatures([feature], {
                    dataProjection: 'EPSG:4326',
                    featureProjection: 'EPSG:3857'
                });
                
                // åˆ›å»ºBlobå¯¹è±¡
                const blob = new Blob([kml], {type: 'application/vnd.google-earth.kml+xml'});
                
                // åˆ›å»ºä¸‹è½½é“¾æ¥
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.style.display = 'none';
                a.href = url;
                a.download = `${getGeometryName(type)}_${index + 1}.kml`;
                
                // è§¦å‘ä¸‹è½½
                document.body.appendChild(a);
                a.click();
                
                // æ¸…ç†
                window.URL.revokeObjectURL(url);
                document.body.removeChild(a);
            }
        }

        // ä¿®æ”¹ updateScale å‡½æ•°
        function updateScale() {
            if (!map) return; // æ·»åŠ æ£€æŸ¥

            const view = map.getView();
            if (!view) return; // æ·»åŠ æ£€æŸ¥

            const projection = view.getProjection();
            const center = view.getCenter();
            const resolution = view.getResolution();
            
            if (!projection || !resolution) return; // æ·»åŠ æ£€æŸ¥
            
            // è®¡ç®—æ¯”ä¾‹å°º
            const mpu = projection.getMetersPerUnit();
            const dpi = 25.4 / 0.28;
            const scale = Math.round(resolution * mpu * 39.37 * dpi);
            
            // æ ¼å¼åŒ–æ¯”ä¾‹å°ºæ˜¾ç¤º
            let scaleText;
            if (scale >= 1000000) {
                scaleText = `1:${(scale/1000000).toFixed(1)}M`;
            } else if (scale >= 1000) {
                scaleText = `1:${(scale/1000).toFixed(0)}K`;
            } else {
                scaleText = `1:${scale}`;
            }
            
            const scaleElement = document.getElementById('scale');
            if (scaleElement) {
                scaleElement.textContent = `æ¯”ä¾‹å°º: ${scaleText}`;
            }
        }

        // åˆ†æå·¥å…·åŠŸèƒ½
        function initAnalysisTools() {
            // ä¸ºåˆ†æå·¥å…·æŒ‰é’®æ·»åŠ ç‚¹å‡»äº‹ä»¶
            document.querySelectorAll('.analysis-button').forEach(button => {
                button.addEventListener('click', function() {
                    const type = this.getAttribute('title');
                    switch(type) {
                        case 'ç¼“å†²åŒºåˆ†æ':
                            showBufferDialog();
                            break;
                        case 'ç›¸äº¤åˆ†æ':
                            showIntersectDialog();
                            break;
                        case 'åˆå¹¶åˆ†æ':
                            showUnionDialog();
                            break;
                    }
                });
            });
        }

        // ç¼“å†²åŒºåˆ†æå¯¹è¯æ¡†
        function showBufferDialog() {
            const dialogHtml = `
                <div class="analysis-dialog" id="bufferDialog">
                    <div class="dialog-header">
                        <h3>ç¼“å†²åŒºåˆ†æ</h3>
                        <span class="close-btn" onclick="closeDialog('bufferDialog')">&times;</span>
                    </div>
                    <div class="dialog-content">
                        <div class="input-group">
                            <label>ç¼“å†²è·ç¦» (ç±³):</label>
                            <input type="number" id="bufferDistance" value="1000" min="1">
                        </div>
                        <div class="input-group">
                            <label>æ ·å¼è®¾ç½®:</label>
                            <div class="style-row">
                                <label>å¡«å……é¢œè‰²:</label>
                                <input type="color" id="bufferFillColor" value="#66ccff">
                                <input type="range" id="bufferOpacity" min="0" max="1" step="0.1" value="0.3">
                            </div>
                        </div>
                        <div class="dialog-buttons">
                            <button class="primary-button" onclick="executeBuffer()">ç¡®å®š</button>
                            <button class="secondary-button" onclick="closeDialog('bufferDialog')">å–æ¶ˆ</button>
                        </div>
                    </div>
                </div>
            `;
            showDialog(dialogHtml);
        }

        // ç›¸äº¤åˆ†æå¯¹è¯æ¡†
        function showIntersectDialog() {
            const dialogHtml = `
                <div class="analysis-dialog" id="intersectDialog">
                    <div class="dialog-header">
                        <h3>ç›¸äº¤åˆ†æ</h3>
                        <span class="close-btn" onclick="closeDialog('intersectDialog')">&times;</span>
                    </div>
                    <div class="dialog-content">
                        <p>è¯·å…ˆé€‰æ‹©ä¸¤ä¸ªè¦ç´ è¿›è¡Œç›¸äº¤åˆ†æ</p>
                        <div class="dialog-buttons">
                            <button class="primary-button" onclick="executeIntersect()">å¼€å§‹åˆ†æ</button>
                            <button class="secondary-button" onclick="closeDialog('intersectDialog')">å–æ¶ˆ</button>
                        </div>
                    </div>
                </div>
            `;
            showDialog(dialogHtml);
        }

        // åˆå¹¶åˆ†æå¯¹è¯æ¡†
        function showUnionDialog() {
            const dialogHtml = `
                <div class="analysis-dialog" id="unionDialog">
                    <div class="dialog-header">
                        <h3>åˆå¹¶åˆ†æ</h3>
                        <span class="close-btn" onclick="closeDialog('unionDialog')">&times;</span>
                    </div>
                    <div class="dialog-content">
                        <p>è¯·å…ˆé€‰æ‹©è¦åˆå¹¶çš„è¦ç´ </p>
                        <div class="dialog-buttons">
                            <button class="primary-button" onclick="executeUnion()">å¼€å§‹åˆå¹¶</button>
                            <button class="secondary-button" onclick="closeDialog('unionDialog')">å–æ¶ˆ</button>
                        </div>
                    </div>
                </div>
            `;
            showDialog(dialogHtml);
        }

        // é€šç”¨å¯¹è¯æ¡†æ˜¾ç¤ºå‡½æ•°
        function showDialog(html) {
            const overlay = document.createElement('div');
            overlay.className = 'dialog-overlay';
            overlay.innerHTML = html;
            document.body.appendChild(overlay);
        }

        // é€šç”¨å¯¹è¯æ¡†å…³é—­å‡½æ•°
        function closeDialog(dialogId) {
            const dialog = document.getElementById(dialogId);
            if (dialog && dialog.parentElement) {
                dialog.parentElement.remove();
            }
        }

        // åœ¨é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–åˆ†æå·¥å…·
        document.addEventListener('DOMContentLoaded', initAnalysisTools);

        // æ‰§è¡Œç¼“å†²åŒºåˆ†æ
        function executeBuffer() {
            try {
                // æ£€æŸ¥æ˜¯å¦æœ‰é€‰ä¸­çš„è¦ç´ 
                if (!selectInteraction || selectInteraction.getFeatures().getLength() === 0) {
                    alert('è¯·å…ˆé€‰æ‹©è¦ç´ ');
                    closeDialog('bufferDialog');
                    return;
                }

                const distance = parseFloat(document.getElementById('bufferDistance').value);
                const fillColor = document.getElementById('bufferFillColor').value;
                const opacity = document.getElementById('bufferOpacity').value;

                const selectedFeatures = selectInteraction.getFeatures();
                const feature = selectedFeatures.item(0);

                // è½¬æ¢è¦ç´ ä¸ºGeoJSON
                const format = new ol.format.GeoJSON();
                const geojson = format.writeFeatureObject(feature, {
                    dataProjection: 'EPSG:4326',
                    featureProjection: 'EPSG:3857'
                });

                // ä½¿ç”¨turfåˆ›å»ºç¼“å†²åŒº
                const buffered = turf.buffer(geojson, distance / 1000, { 
                    units: 'kilometers',
                    steps: 64  // å¢åŠ æ­¥æ•°ä½¿ç¼“å†²åŒºæ›´å¹³æ»‘
                });

                // è½¬æ¢å›OpenLayersè¦ç´ 
                const bufferFeature = format.readFeature(buffered, {
                    dataProjection: 'EPSG:4326',
                    featureProjection: 'EPSG:3857'
                });

                // è®¾ç½®ç¼“å†²åŒºæ ·å¼
                const bufferStyle = new ol.style.Style({
                    fill: new ol.style.Fill({
                        color: hexToRgba(fillColor, opacity)
                    }),
                    stroke: new ol.style.Stroke({
                        color: fillColor,
                        width: 2
                    })
                });
                bufferFeature.setStyle(bufferStyle);

                // æ·»åŠ åˆ°å›¾å±‚å¹¶ç¡®ä¿ç«‹å³æ¸²æŸ“
                drawSource.addFeature(bufferFeature);
                
                // ç¼©æ”¾åˆ°ç¼“å†²åŒºèŒƒå›´
                const extent = bufferFeature.getGeometry().getExtent();
                map.getView().fit(extent, {
                    padding: [50, 50, 50, 50],
                    duration: 500
                });

                // è§¦å‘å›¾å±‚æ›´æ–°
                drawSource.changed();
                drawLayer.changed();
                
                // æ›´æ–°è¦ç´ åˆ—è¡¨
                updateFeaturesList();

                // å…³é—­å¯¹è¯æ¡†
                closeDialog('bufferDialog');

                // æç¤ºæˆåŠŸ
                alert('ç¼“å†²åŒºåˆ†æå®Œæˆ');

            } catch (error) {
                console.error('æ‰§è¡Œç¼“å†²åŒºåˆ†ææ—¶å‡ºé”™:', error);
                alert('æ‰§è¡Œç¼“å†²åŒºåˆ†æå¤±è´¥: ' + error.message);
            }
        }

        // æ‰§è¡Œç›¸äº¤åˆ†æ
        function executeIntersect() {
            try {
                // å…ˆå¯ç”¨é€‰æ‹©æ¨¡å¼
                if (!selectInteraction) {
                    enableEdit();
                }

                // æ£€æŸ¥é€‰ä¸­çš„è¦ç´ æ•°é‡
                const selectedFeatures = selectInteraction.getFeatures();
                if (selectedFeatures.getLength() < 2) {
                    alert('è¯·å…ˆé€‰æ‹©ä¸¤ä¸ªè¦ç´ è¿›è¡Œç›¸äº¤åˆ†æ\n\næ“ä½œæ­¥éª¤ï¼š\n1. æŒ‰ä½Shifté”®\n2. ç‚¹å‡»é€‰æ‹©ç¬¬ä¸€ä¸ªè¦ç´ \n3. ç»§ç»­æŒ‰ä½Shifté”®\n4. ç‚¹å‡»é€‰æ‹©ç¬¬äºŒä¸ªè¦ç´ ');
                    return;
                }

                const features = selectedFeatures.getArray();
                const format = new ol.format.GeoJSON();

                // è½¬æ¢è¦ç´ ä¸ºGeoJSONå¹¶å¤„ç†ç‰¹æ®Šå‡ ä½•ç±»å‹
                const feature1 = processGeometry(features[0], format);
                const feature2 = processGeometry(features[1], format);

                // è®¡ç®—ç›¸äº¤
                const intersection = turf.intersect(feature1, feature2);

                if (intersection) {
                    // è½¬æ¢å›OpenLayersè¦ç´ 
                    const intersectFeature = format.readFeature(intersection, {
                        dataProjection: 'EPSG:4326',
                        featureProjection: 'EPSG:3857'
                    });

                    // è®¾ç½®ç›¸äº¤ç»“æœæ ·å¼
                    intersectFeature.setStyle(new ol.style.Style({
                        fill: new ol.style.Fill({
                            color: 'rgba(255, 100, 100, 0.3)'
                        }),
                        stroke: new ol.style.Stroke({
                            color: '#ff4444',
                            width: 2
                        })
                    }));

                    // æ·»åŠ åˆ°å›¾å±‚
                    drawSource.addFeature(intersectFeature);

                    // ç¼©æ”¾åˆ°ç›¸äº¤ç»“æœèŒƒå›´
                    const extent = intersectFeature.getGeometry().getExtent();
                    map.getView().fit(extent, {
                        padding: [50, 50, 50, 50],
                        duration: 500
                    });

                    // æ›´æ–°è¦ç´ åˆ—è¡¨
                    updateFeaturesList();
                    closeDialog('intersectDialog');
                    alert('ç›¸äº¤åˆ†æå®Œæˆ');
                } else {
                    alert('æ‰€é€‰è¦ç´ æ²¡æœ‰ç›¸äº¤éƒ¨åˆ†');
                }

            } catch (error) {
                console.error('æ‰§è¡Œç›¸äº¤åˆ†ææ—¶å‡ºé”™:', error);
                alert('æ‰§è¡Œç›¸äº¤åˆ†æå¤±è´¥: ' + error.message);
            }
        }

        // æ‰§è¡Œåˆå¹¶åˆ†æ
        function executeUnion() {
            try {
                if (!selectInteraction || selectInteraction.getFeatures().getLength() < 2) {
                    alert('è¯·å…ˆé€‰æ‹©è‡³å°‘ä¸¤ä¸ªè¦ç´ ');
                    closeDialog('unionDialog');
                    return;
                }

                const features = selectInteraction.getFeatures().getArray();
                const format = new ol.format.GeoJSON();
                let unionFeature = null;

                // è½¬æ¢å¹¶åˆå¹¶è¦ç´ 
                features.forEach((feature, index) => {
                    const geojson = processGeometry(feature, format);

                    if (index === 0) {
                        unionFeature = geojson;
                    } else {
                        unionFeature = turf.union(unionFeature, geojson);
                    }
                });

                if (unionFeature) {
                    // è½¬æ¢å›OpenLayersè¦ç´ 
                    const mergedFeature = format.readFeature(unionFeature, {
                        dataProjection: 'EPSG:4326',
                        featureProjection: 'EPSG:3857'
                    });

                    // è®¾ç½®åˆå¹¶ç»“æœæ ·å¼
                    mergedFeature.setStyle(new ol.style.Style({
                        fill: new ol.style.Fill({
                            color: 'rgba(100, 255, 100, 0.3)'
                        }),
                        stroke: new ol.style.Stroke({
                            color: '#44cc44',
                            width: 2
                        })
                    }));

                    // æ·»åŠ åˆ°å›¾å±‚
                    drawSource.addFeature(mergedFeature);

                    // ç¼©æ”¾åˆ°ç»“æœèŒƒå›´
                    const extent = mergedFeature.getGeometry().getExtent();
                    map.getView().fit(extent, {
                        padding: [50, 50, 50, 50],
                        duration: 500
                    });

                    // æ›´æ–°è¦ç´ åˆ—è¡¨
                    updateFeaturesList();
                    closeDialog('unionDialog');
                    alert('åˆå¹¶åˆ†æå®Œæˆ');
                }

            } catch (error) {
                console.error('æ‰§è¡Œåˆå¹¶åˆ†ææ—¶å‡ºé”™:', error);
                alert('æ‰§è¡Œåˆå¹¶åˆ†æå¤±è´¥: ' + error.message);
            }
        }

        // å¤„ç†å‡ ä½•è¦ç´ 
        function processGeometry(feature, format) {
            const geometry = feature.getGeometry();
            const type = geometry.getType();
            
            // è½¬æ¢ä¸ºGeoJSON
            let geojson = format.writeFeatureObject(feature, {
                dataProjection: 'EPSG:4326',
                featureProjection: 'EPSG:3857'
            });

            // å¤„ç†ç‰¹æ®Šå‡ ä½•ç±»å‹
            if (type === 'Circle') {
                // å°†åœ†è½¬æ¢ä¸º32è¾¹å½¢
                const center = geometry.getCenter();
                const radius = geometry.getRadius();
                const circle = turf.circle(
                    turf.point(ol.proj.transform(center, 'EPSG:3857', 'EPSG:4326')),
                    radius / 1000, // è½¬æ¢ä¸ºåƒç±³
                    { steps: 32, units: 'kilometers' }
                );
                geojson = circle;
            } else if (type === 'LineString') {
                // ä¸ºçº¿æ¡åˆ›å»ºç¼“å†²åŒº
                const line = geojson;
                const buffered = turf.buffer(line, 0.1, { units: 'meters' });
                geojson = buffered;
            }

            return geojson;
        }

        // è¾…åŠ©å‡½æ•°ï¼šè½¬æ¢åå…­è¿›åˆ¶é¢œè‰²åˆ°rgba
        function hexToRgba(hex, opacity) {
            hex = hex.replace('#', '');
            const r = parseInt(hex.substring(0, 2), 16);
            const g = parseInt(hex.substring(2, 4), 16);
            const b = parseInt(hex.substring(4, 6), 16);
            return `rgba(${r}, ${g}, ${b}, ${opacity})`;
        }

        // æ·»åŠ å›¾å±‚åˆ—è¡¨æ›´æ–°å‡½æ•°
        function updateLayersList() {
            const layersList = document.getElementById('layers-list');
            if (!layersList) return;

            // ä¿ç•™åŸºç¡€å›¾å±‚
            const baseLayersHtml = `
                <div class="layer-item">
                    <button class="layer-button gaode-layer" data-layer="gaode">
                        <div class="layer-icon"></div>
                        <span>é«˜å¾·åœ°å›¾</span>
                    </button>
                </div>
                <div class="layer-item">
                    <button class="layer-button arcgis-layer" data-layer="arcgis">
                        <div class="layer-icon"></div>
                        <span>ArcGISå«æ˜Ÿå½±åƒ</span>
                    </button>
                </div>
            `;

            // æ·»åŠ æœ¬åœ°å›¾å±‚
            let localLayersHtml = '';
            localLayers.forEach((layer, name) => {
                localLayersHtml += `
                    <div class="layer-item">
                        <div class="layer-info">
                            <input type="checkbox" ${layer.getVisible() ? 'checked' : ''} 
                                   onchange="toggleLayerVisibility('${name}')">
                            <span>${name}</span>
                        </div>
                        <div class="layer-controls">
                            <button title="ä¸Šç§»" onclick="moveLayer('${name}', 'up')">â†‘</button>
                            <button title="ä¸‹ç§»" onclick="moveLayer('${name}', 'down')">â†“</button>
                            <button title="åˆ é™¤" onclick="removeLayer('${name}')">Ã—</button>
                        </div>
                    </div>
                `;
            });

            layersList.innerHTML = baseLayersHtml + localLayersHtml;
        }

        // æ·»åŠ å›¾å±‚å¯è§æ€§åˆ‡æ¢å‡½æ•°
        function toggleLayerVisibility(layerName) {
            const layer = localLayers.get(layerName);
            if (layer) {
                layer.setVisible(!layer.getVisible());
            }
        }

        // æ·»åŠ å›¾å±‚ç§»åŠ¨å‡½æ•°
        function moveLayer(layerName, direction) {
            const layer = localLayers.get(layerName);
            if (!layer) return;

            const layers = Array.from(localLayers.entries());
            const currentIndex = layers.findIndex(([name]) => name === layerName);
            
            if (direction === 'up' && currentIndex > 0) {
                // å‘ä¸Šç§»åŠ¨
                [layers[currentIndex], layers[currentIndex - 1]] = [layers[currentIndex - 1], layers[currentIndex]];
            } else if (direction === 'down' && currentIndex < layers.length - 1) {
                // å‘ä¸‹ç§»åŠ¨
                [layers[currentIndex], layers[currentIndex + 1]] = [layers[currentIndex + 1], layers[currentIndex]];
            }

            // æ›´æ–°å›¾å±‚é¡ºåº
            localLayers.clear();
            layers.forEach(([name, layer]) => {
                localLayers.set(name, layer);
            });

            // æ›´æ–°æ˜¾ç¤º
            updateLayersList();
        }
    </script>
</body>
</html>